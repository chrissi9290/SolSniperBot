<script>
    let walletPublicKey = null;

    document.getElementById('connectPhantom').onclick = async () => {
        if (window.solana && window.solana.isPhantom) {
            try {
                const resp = await window.solana.connect();
                walletPublicKey = resp.publicKey.toString();
                document.getElementById('walletAddress').innerText = `Verbunden: ${walletPublicKey}`;
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('walletBalanceSection').classList.remove('hidden');
                addLog("Phantom Wallet erfolgreich verbunden.");
                updateWalletBalance();
                setInterval(updateWalletBalance, 60000); // Aktualisierung alle 60 Sekunden
            } catch (err) {
                addLog("Fehler bei der Verbindung zur Phantom Wallet: " + err.message);
            }
        } else {
            addLog("Phantom Wallet nicht gefunden. Bitte installieren.");
        }
    };

    async function updateWalletBalance() {
        if (!walletPublicKey) return;
        
        try {
            addLog("Aktualisiere Kontostand der Wallet...");
            
            // Verwende Ankr RPC-Endpunkt
            const connection = new solanaWeb3.Connection('https://rpc.ankr.com/solana');
            
            const tokenAccounts = await connection.getTokenAccountsByOwner(
                new solanaWeb3.PublicKey(walletPublicKey),
                { programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
            );

            const tokenList = document.getElementById('tokenList');
            tokenList.innerHTML = "";

            if (tokenAccounts.value.length === 0) {
                addLog("Keine Token auf der Wallet gefunden.");
                tokenList.innerHTML = `<tr><td colspan="2" class="p-2 text-center">Keine Token verf√ºgbar</td></tr>`;
                return;
            }

            tokenAccounts.value.forEach(tokenAccount => {
                const accountInfo = await connection.getParsedAccountInfo(tokenAccount.pubkey);
                const parsedInfo = accountInfo.value.data.parsed.info;
                tokenList.innerHTML += `
                    <tr>
                        <td class="p-2">${parsedInfo.mint}</td>
                        <td class="p-2">${parsedInfo.tokenAmount.uiAmount}</td>
                    </tr>
                `;
            });

            addLog("Kontostand erfolgreich aktualisiert.");
        } catch (err) {
            addLog("Fehler beim Abrufen des Kontostands: " + err.message);
        }
    }

    function addLog(message) {
        const logsElement = document.getElementById('logs');
        const timeStamp = new Date().toLocaleTimeString();
        logsElement.innerHTML += `<p>[${timeStamp}] ${message}</p>`;
        logsElement.scrollTop = logsElement.scrollHeight;
        console.log(message);
    }
</script>