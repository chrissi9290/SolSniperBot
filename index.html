<script>
    const statusElement = document.getElementById('status');
    const logsElement = document.getElementById('logs');
    const connectButton = document.getElementById('connectButton');
    const walletAddressElement = document.getElementById('walletAddress');
    const tokenTable = document.getElementById('tokenTable');

    let walletPublicKey = null;
    let tokenChart = null;

    // Log-Funktion
    function addLog(message) {
        const timeStamp = new Date().toLocaleTimeString();
        logsElement.innerHTML += `<p>[${timeStamp}] ${message}</p>`;
        logsElement.scrollTop = logsElement.scrollHeight;
        console.log(message); // ZusÃ¤tzliche Ausgabe in der Browser-Konsole
    }

    // Phantom Wallet verbinden
    connectButton.onclick = async () => {
        addLog("Verbindung zur Phantom Wallet wird hergestellt...");
        try {
            const resp = await window.solana.connect();
            walletPublicKey = resp.publicKey.toString();
            walletAddressElement.innerText = `Verbunden: ${walletPublicKey}`;
            addLog("Phantom Wallet erfolgreich verbunden.");
            loadWalletTokens();
            setInterval(loadWalletTokens, 30000); // Alle 30 Sekunden aktualisieren
        } catch (err) {
            addLog("Verbindung zur Phantom Wallet fehlgeschlagen: " + err.message);
        }
    };

    // Token-Mengen auslesen und Chart aktualisieren
    async function loadWalletTokens() {
        if (!walletPublicKey) return;

        addLog("Aktualisiere Token-Mengen der Wallet...");
        try {
            const connection = new solanaWeb3.Connection('https://mainnet.helius-rpc.com/?api-key=95d3b715-1052-43c6-bb0b-e1136b44961b');
            const tokenAccounts = await connection.getParsedTokenAccountsByOwner(
                new solanaWeb3.PublicKey(walletPublicKey),
                { programId: new solanaWeb3.PublicKey("TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA") }
            );

            if (tokenAccounts.value.length === 0) {
                addLog("Keine Token auf der Wallet gefunden.");
                statusElement.innerText = "Wallet ist leer.";
                return;
            }

            const tokenData = tokenAccounts.value.map(tokenAccount => {
                const info = tokenAccount.account.data.parsed.info;
                return { mint: info.mint, amount: info.tokenAmount.uiAmount };
            }).filter(token => token.amount > 0);

            addLog(`Gefundene Token: ${tokenData.length}`);
            updateTokenTable(tokenData);
            statusElement.innerText = "Token-Mengen erfolgreich geladen.";
        } catch (err) {
            addLog("Fehler beim Laden der Token-Mengen: " + err.message);
            statusElement.innerText = "Fehler beim Laden der Token-Mengen.";
        }
    }

    // Aktualisiere die Tabelle mit Token-Daten
    function updateTokenTable(tokenData) {
        tokenTable.innerHTML = "";
        tokenData.forEach(token => {
            tokenTable.innerHTML += `
                <tr>
                    <td class="p-2">${token.mint}</td>
                    <td class="p-2">${token.amount}</td>
                </tr>
            `;
        });
    }
</script>
